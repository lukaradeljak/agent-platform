events {
    worker_connections 1024;
}

http {
    # ─── Collector API ──────────────────────────────────────────────
    # Accesible en: http://<vps-ip>/api/  o  https://<dominio>/api/
    upstream collector {
        server collector:8000;
    }

    # ─── Flower (Monitoreo de Celery) ────────────────────────────────
    # Accesible en: http://<vps-ip>/flower/
    upstream flower {
        server flower:5555;
    }

    # ─── HTTP (redirige a HTTPS en producción) ───────────────────────
    server {
        listen 80;
        server_name _;

        # Para desarrollo sin TLS, comentar el bloque de redirect y descomentar los location blocks
        return 301 https://$host$request_uri;

        # ── Descomentar para HTTP sin TLS (desarrollo) ──────────────
        # location /api/ {
        #     proxy_pass         http://collector/;
        #     proxy_set_header   Host $host;
        #     proxy_set_header   X-Real-IP $remote_addr;
        #     proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        # }
        #
        # location /flower/ {
        #     proxy_pass         http://flower/;
        #     proxy_set_header   Host $host;
        #     proxy_set_header   X-Real-IP $remote_addr;
        #     # Flower necesita esta cabecera para las URLs internas
        #     proxy_set_header   X-Forwarded-Prefix /flower;
        # }
    }

    # ─── HTTPS (producción) ──────────────────────────────────────────
    # Requiere certificado TLS. Usar Let's Encrypt con certbot:
    #   certbot --nginx -d tu-dominio.com
    #
    # server {
    #     listen 443 ssl;
    #     server_name tu-dominio.com;
    #
    #     ssl_certificate     /etc/letsencrypt/live/tu-dominio.com/fullchain.pem;
    #     ssl_certificate_key /etc/letsencrypt/live/tu-dominio.com/privkey.pem;
    #
    #     location /api/ {
    #         proxy_pass         http://collector/;
    #         proxy_set_header   Host $host;
    #         proxy_set_header   X-Real-IP $remote_addr;
    #         proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    #         proxy_set_header   X-Forwarded-Proto https;
    #     }
    #
    #     location /flower/ {
    #         proxy_pass         http://flower/;
    #         proxy_set_header   Host $host;
    #         proxy_set_header   X-Real-IP $remote_addr;
    #         proxy_set_header   X-Forwarded-Prefix /flower;
    #     }
    # }
}
